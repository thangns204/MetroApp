ymaps.modules.define("TransportMap",["util.extend","transportMap.Scheme","transportMap.SchemeView","transportMap.SchemeLayer","transportMap.StationCollection","transportMap.AnnotationCollection","event.Manager","projection.Cartesian","Map"],function(t,e,s,n,i,o,a,h,r,c){function m(t,e,s,n){return this._schemeId=this._schemeIdByCity[t]||t,this._container="string"==typeof e?document.getElementById(e):e[0]||e,n||(n=s,s=null),this._initStateAndOptions(s,n),this._loadScheme().then(this._onSchemeLoad.bind(this))}m.create=function(t,e,s,n){return new m(t,e,s,n)},e(m.prototype,{_initStateAndOptions:function(t,s){this._options=e({path:"public/img/metro-data/",shadeOnSelect:!1,selectOnClick:!0,minZoom:0,maxZoom:3},s),this._state=e({shaded:!1,center:[0,0],selection:[]},t),this._state.hasOwnProperty("zoom")||(this._state.zoom=i.getFitZoom(this._container)),this._state.hasOwnProperty("zoom")||(this._state.zoom=i.getFitZoom(this._container))},_loadScheme:function(){return s.create([this._options.path,this._schemeId,".",this._options.lang,".svg"].join(""))},_onSchemeLoad:function(t){return this._createMap().then(function(e){return this._scheme=t,this._schemeView=new n(t),this._map=e,this._map.layers.add(new i(this._schemeView)),this.stations=new o(this._schemeView,this._options.selectOnClick),this._map.geoObjects.add(this.stations),this.stations.select(this._state.selection),this.annotations=new a(this),this.events=new h,this._map.events.setParent(this.events),this._options.shadeOnSelect&&this.stations.events.add("selectionchange",function(){var t=this.stations.getSelection().length;1===t?this.shade():0===t&&this.unshade()},this),this._state.shaded&&this.shade(),this}.bind(this))},_createMap:function(){var t=new ymaps.vow.Deferred,e=new c(this._container,{controls:[],center:this._state.center,zoom:this._state.zoom,type:null},{minZoom:this._options.minZoom,maxZoom:this._options.maxZoom,autoFitToViewport:"always",avoidFractionalZoom:!1,projection:new r([[-1,-1],[1,1]])});return this._container.clientWidth&&this._container.clientHeight?t.resolve(e):e.events.once("sizechange",function(){Number.isFinite(this._state.zoom)||e.setZoom(i.getFitZoom(this._container)),t.resolve(e)}.bind(this)),t.promise()},shade:function(){this._schemeView.fadeIn(),this.events.fire("shadechange",{type:"shade",target:this})},unshade:function(){this._schemeView.fadeOut(),this.events.fire("shadechange",{type:"unshade",target:this})},getCenter:function(){return this._map.getCenter()},setCenter:function(){return this._map.setCenter.apply(this._map,arguments)},getZoom:function(){return this._map.getZoom()},setZoom:function(){return this._map.setZoom.apply(this._map,arguments)},getSchemeId:function(){return this._schemeId},_schemeIdByCity:{moscow:1,spb:2,kiev:8,kharkov:9,minsk:13},getMap:function(){return this._map},destroy:function(){this._map.destroy()}}),t(m)});
ymaps.modules.define("transportMap.Annotation",["util.extend","util.augment","geometry.Point","Placemark","layout.storage","templateLayoutFactory"],function(t,o,e,a,r,n,i){function s(t,e,a){s.superclass.constructor.call(this,t,o({arrowColor:this._getArrowColor(e.iconColor),textColor:this._getTextColor(e.iconColor)},e),o({iconLayout:"transportMap#annotation"},a))}function l(t){var o,e=[];for(o in t)t.hasOwnProperty(o)&&e.push(o+":"+t[o]);return e.join(";")}e(s,r,{_getRGBA:function(t){var o;return this._ctx||(o=document.createElement("canvas"),o.width=o.height=1,this._ctx=o.getContext("2d")),this._ctx.clearRect(0,0,1,1),this._ctx.fillStyle=t,this._ctx.fillRect(0,0,1,1),Array.prototype.slice.apply(this._ctx.getImageData(0,0,1,1).data)},_getArrowColor:function(t){var o=this._getRGBA(t).map(function(t){return Math.floor(.9*t)});return o[3]=1,"rgba("+o+")"},_getTextColor:function(t){var o=this._getRGBA(t),e="rgba(0, 0, 0, 0.9)",a="white";return(o[0]+o[1]+o[2])/3>128?e:a}});var p={overflow:"hidden",position:"absolute",left:'{{ options.offset.0|default:"-71" }}px',top:'{{ options.offset.1|default:"-108" }}px',height:"110px"},c={color:'{{ properties.textColor|default:"black"}}',"font-family":"Arial,Helvetica,sans-serif",background:'{{ properties.iconColor|default:"white" }}',"white-space":"nowrap",display:"block",padding:"10px"},u=["-moz-","-webkit-","-o-","-ms-",""].reduce(function(t,o){return t[o+"transform"]="rotate(45deg) skewX(75deg)",t},{position:"absolute",content:"",width:"100px",height:"100px","background-color":'{{ properties.arrowColor|default:"white" }}',left:"-110px",top:"-143px","z-index":-1});n.add("transportMap#annotation",i.createClass('<ymaps class="ymaps-tm-annotation" style="'+l(p)+'"><ymaps class="ymaps-tm-annotation-content" style="'+l(c)+'">{{ properties.iconContent }}</ymaps><ymaps class="ymaps-tm-annotation-arrow" style="'+l(u)+'"></ymaps></ymaps>',{})),t(s)});
ymaps.modules.define("transportMap.AnnotationCollection",["util.augment","Collection"],function(t,n,o){function i(t){i.superclass.constructor.call(this),this._map=t}n(i,o,{getMap:function(){return this._map}}),t(i)});
ymaps.modules.define("transportMap.Scheme",["vow","util.extend"],function(t,e,n){var a=function(t){return this._load(t)};a.create=function(t){return new a(t)},n(a.prototype,{_load:function(t){var n,a,r=new XMLHttpRequest,i=new e.Deferred;return r.onreadystatechange=function(){if(4===r.readyState)try{n=this._text=r.responseText,this._node=(new DOMParser).parseFromString(n,"text/xml").firstChild,a=this._node.getElementsByTagName("metadata")[0],this._metaData=JSON.parse(a.firstChild.data),i.resolve(this)}catch(t){i.reject(t)}}.bind(this),r.onerror=function(t){i.reject(t)},r.open("GET",t,!0),r.send(null),i.promise()},createDom:function(){return this._node.cloneNode(!0)},getCity:function(){return this._metaData.name},getSize:function(){return[this._metaData.width,this._metaData.height]},getStations:function(){return this._metaData.stations},getLabel:function(t){return this._metaData.labels[t]}}),t(a)});
ymaps.modules.define("transportMap.SchemeLayer",["util.augment","collection.Item","transportMap.SchemeView"],function(e,t,i,n){function o(e){o.superclass.constructor.call(this),this._schemeView=e}t(o,i,{onAddToMap:function(e){o.superclass.onAddToMap.call(this,e),this._pane=e.panes.get("ground"),this._updateSchemePosition(),this._pane.events.add(["viewportchange","zoomchange","clientpixelschange"],this._updateSchemePosition,this),this._pane.getElement().appendChild(this._schemeView.getNode())},_updateSchemePosition:function(){this._schemeView.updatePosition(this._pane.toClientPixels([0,0]),Math.pow(2,this._pane.getZoom()))},getSchemeView:function(){return this._schemeView}}),o.getFitZoom=function(e){return Math.log(Math.min(e.clientWidth/n.ZERO_ZOOM_SIZE,e.clientHeight/n.ZERO_ZOOM_SIZE))/Math.LN2},e(o)});
ymaps.modules.define("transportMap.SchemeView",["util.extend"],function(e,t){function i(e){this._scheme=e,this._selfSize=e.getSize(),this._zeroZoomScale=Math.min(s/this._selfSize[0],s/this._selfSize[1]),this._offset=[Math.floor((s-this._selfSize[0]*this._zeroZoomScale)/2),Math.floor((s-this._selfSize[1]*this._zeroZoomScale)/2)],this._node=document.createElement("ymaps"),t(this._node.style,{position:"absolute",width:this._selfSize[0]+"px",height:this._selfSize[1]+"px"}),this._schemeNode=e.createDom(),this._schemeNode.setAttribute("width","100%"),this._schemeNode.setAttribute("height","100%"),this._schemeNode.setAttribute("viewBox",[0,0,this._selfSize[0],this._selfSize[1]].join(" ")),this._node.appendChild(this._schemeNode)}var s=256;i.ZERO_ZOOM_SIZE=s,t(i.prototype,{fadeOut:function(){this._schemeNode.getElementById("scheme-layer").style.opacity=""},fadeIn:function(){this._schemeNode.getElementById("scheme-layer").style.opacity=.5},updatePosition:function(e,i){var s=this._zeroZoomScale*i,o=[this._offset[0]+e[0],this._offset[1]+e[1]],h="translate("+o[0]+"px,"+o[1]+"px)";["-webkit-","-moz-","-ms-","-o-",""].forEach(function(e){this._node.style[e+"transform-origin"]="0px 0px",this._node.style[e+"transform"]=h},this),t(this._node.style,{width:this._selfSize[0]*s+"px",height:this._selfSize[1]*s+"px"})},getNode:function(){return this._node},getScheme:function(){return this._scheme},getSchemeNode:function(){return this._schemeNode},toClientPixels:function(e,t){var i=Math.pow(2,t),s=[e[0]/i,e[1]/i];return[s[0]/this._zeroZoomScale-this._offset[0],s[1]/this._zeroZoomScale-this._offset[1]]},fromClientPixels:function(e,t){var i=[(e[0]+this._offset[0])*this._zeroZoomScale,(e[1]+this._offset[1])*this._zeroZoomScale],s=Math.pow(2,t);return[i[0]*s,i[1]*s]}}),e(i)});
ymaps.modules.define("transportMap.Station",["util.augment","vow","collection.Item","Rectangle"],function(e,t,s,i,o){function n(e,t,s){n.superclass.constructor.call(this,s),this._schemeView=t,this.code=e.labelId,this.title=e.name,this.selected=!1,this._annotations=[]}t(n,i,{onAddToMap:function(){n.superclass.onAddToMap.apply(this,arguments),this._getGeoObjects().forEach(function(e){e.events.setParent(this.events)},this)},getLabelNode:function(){return this._schemeView.getSchemeNode().getElementById("label-"+this.code)},getNode:function(){return this._schemeView.getSchemeNode().getElementById("station-"+this.code)},select:function(){var e;this.selected||(e=this.getLabelNode().getElementsByTagName("rect")[0],this.selected=!0,e.style.stroke="#bbb",e.style.opacity=1,this._appendTo("highlight-layer-stations",this._getStationNodes()),this._appendTo("highlight-layer-labels",this.getLabelNode()),this.events.fire("selectionchange",{type:"select",target:this}))},deselect:function(){var e;this.selected&&(e=this.getLabelNode().getElementsByTagName("rect")[0],this.selected=!1,e.style.stroke="",e.style.opacity="",this._appendTo("scheme-layer-stations",this._getStationNodes()),this._appendTo("scheme-layer-labels",this.getLabelNode()),this.events.fire("selectionchange",{type:"deselect",target:this}))},_appendTo:function(e,t){var s=this._schemeView.getSchemeNode().getElementById(e);[].concat(t).forEach(function(e){s.appendChild(e)})},_getGeoObjects:function(){var e=[this.getLabelNode()].concat(this._getStationNodes());return e.map(this._createGeoObject,this)},_getStationNodes:function(){var e=this._schemeView.getScheme().getLabel(this.code);return e.stationIds.map(function(e){return this._schemeView.getSchemeNode().getElementById("station-"+e)},this)},_createGeoObject:function(e){var t=new o(this._getGeoBBox(e),{},{fill:!0,opacity:0});return this.getMap().geoObjects.add(t),t},_getGeoBBox:function(e){var t=this._schemeView,s=this.getMap().options.get("projection"),i=this.getMap().getZoom(),o=e.getBBox();return[s.fromGlobalPixels(t.fromClientPixels([o.x,o.y],i),i),s.fromGlobalPixels(t.fromClientPixels([o.x+o.width,o.y+o.height],i),i)]},getPosition:function(){var e=this._getGeoBBox(this.getNode());return[(e[0][0]+e[1][0])/2,(e[0][1]+e[1][1])/2]},getCoordinates:function(){return ymaps.geocode(this._schemeView.getScheme().getCity(),{results:1,kind:"locality"}).then(function(e){return ymaps.geocode("metro "+this.title,{results:1,kind:"metro",boundedBy:e.geoObjects.get(0).geometry.getBounds()}).then(function(e){return e.geoObjects.get(0).geometry.getCoordinates()})}.bind(this))},annotate:function(e,t,i){var o=new s.Deferred;return e=e||{},e.iconColor=this.getNode().getAttribute("fill"),ymaps.modules.require("transportMap.Annotation").spread(function(s){var n=new s(this.getPosition(),e,t);this._annotations.push(n),i||this.getMap().geoObjects.add(n),o.resolve(n)}.bind(this),o.reject.bind(o)),o.promise()}}),e(n)});
ymaps.modules.define("transportMap.StationCollection",["util.augment","vow","Collection","transportMap.Station"],function(t,e,n,i,s){function c(t,e){c.superclass.constructor.call(this);var n,i,o=t.getScheme().getStations();this._stationsMap={};for(n in o)i=new s(o[n],t),this._stationsMap[n]=i,this.add(i),i.events.setParent(this.events);e&&this.setSelectOnClick(!0)}e(c,i,{setSelectOnClick:function(t){var e=t?"add":"remove";this.each(function(t){t.events[e]("click",this._onStationClick,t)},this)},_onStationClick:function(){this[this.selected?"deselect":"select"]()},select:function(t){[].concat(t).forEach(function(t){this.getByCode(t).select()},this)},deselect:function(t){t=t||this.getSelection(),[].concat(t).forEach(function(t){this.getByCode(t).deselect()},this)},getSelection:function(){var t=[];return this.each(function(e){e.selected&&t.push(e.code)}),t},getByCode:function(t){return this._stationsMap[t]},search:function(t){return new n.fulfill(this.filter(function(e){return e.title.split(" ").some(function(e){return e.substr(0,t.length)===t})}))}}),t(c)});
